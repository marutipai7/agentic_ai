<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Data Analytics Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
<style>
    @keyframes slideIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .slide-in {
        animation: slideIn 0.5s ease-out;
    }
    .stat-card {
        transition: all 0.3s ease;
    }
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
</style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-3">
                    <div class="bg-gradient-to-r from-purple-600 to-indigo-600 p-2 rounded-lg">
                        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                    </div>
                    <h1 class="text-2xl font-bold bg-gradient-to-r from-purple-600 to-indigo-600 bg-clip-text text-transparent">
                        Data Analytics Dashboard
                    </h1>
                </div>
                <a href="#" 
                onclick="openDbModal()" 
                class="bg-gradient-to-r from-green-500 to-green-600 text-white px-6 py-2 rounded-lg hover:from-green-600 hover:to-green-700 transition transform hover:scale-105 shadow-md flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 7v10c0 1.1.9 2 2 2h12a2 2 0 002-2V7m-8 10V5m0 0l-3 3m3-3l3 3"></path>
                    </svg>
                    Connect to Database
                </a>
                <a href="/logout" class="bg-gradient-to-r from-red-500 to-red-600 text-white px-6 py-2 rounded-lg hover:from-red-600 hover:to-red-700 transition transform hover:scale-105 shadow-md flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                    </svg>
                    Logout
                </a>
            </div>
        </div>
    </nav>
    <div id="dbModal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-60 flex justify-center items-center z-50">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-96">
            <h2 class="text-xl font-bold mb-4 text-gray-800">Connect to Database</h2>
            <form id="dbConnectForm">
            <label class="block mb-2 text-sm font-semibold text-gray-600">Database Type</label>
            <select name="db_type" class="w-full border rounded-lg px-3 py-2 mb-4" required>
                <option value="postgresql">PostgreSQL</option>
                <option value="mysql">MySQL</option>
                <option value="mongodb">MongoDB</option>
            </select>

            <label class="block mb-2 text-sm font-semibold text-gray-600">Host</label>
            <input type="text" name="host" class="w-full border rounded-lg px-3 py-2 mb-4" required>

            <label class="block mb-2 text-sm font-semibold text-gray-600">Port</label>
            <input type="text" name="port" class="w-full border rounded-lg px-3 py-2 mb-4" required>

            <label class="block mb-2 text-sm font-semibold text-gray-600">Database Name</label>
            <input type="text" name="database" class="w-full border rounded-lg px-3 py-2 mb-4" required>

            <label class="block mb-2 text-sm font-semibold text-gray-600">Username</label>
            <input type="text" name="username" class="w-full border rounded-lg px-3 py-2 mb-4">

            <label class="block mb-2 text-sm font-semibold text-gray-600">Password</label>
            <input type="password" name="password" class="w-full border rounded-lg px-3 py-2 mb-4">

            <div class="flex justify-end space-x-3">
                <button type="button" onclick="closeDbModal()" class="px-4 py-2 bg-gray-300 rounded-lg">Cancel</button>
                <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Connect</button>
            </div>
            </form>
        </div>
    </div>
    <div id="dbSchemaContainer"></div>
    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 py-8 flex gap-6">
        <!-- Left Side: Main Dashboard Content -->
        <div class="flex-1">
        <!-- User Profile Section -->
            <div class="bg-white rounded-2xl shadow-xl p-8 mb-8 slide-in">
                <div class="flex flex-col md:flex-row items-center md:items-start space-y-4 md:space-y-0 md:space-x-6">
                    {% if user.profile_pic_path %}
                    <div class="relative">
                        <img src="{{ url_for('static', filename=user.profile_pic_path.lstrip('static/')) }}" alt="Profile Picture" class="w-32 h-32 rounded-full object-cover border-4 border-purple-500 shadow-lg">
                        <div class="absolute bottom-0 right-0 w-8 h-8 bg-green-500 rounded-full border-4 border-white"></div>
                    </div>
                    {% else %}
                    <div class="relative">
                        <div class="w-32 h-32 rounded-full bg-gradient-to-br from-purple-500 to-indigo-600 flex items-center justify-center border-4 border-purple-500 shadow-lg">
                            <span class="text-4xl text-white font-bold">{{ user.first_name[0] }}{{ user.last_name[0] }}</span>
                        </div>
                        <div class="absolute bottom-0 right-0 w-8 h-8 bg-green-500 rounded-full border-4 border-white"></div>
                    </div>
                    {% endif %}
                    
                    <div class="flex-1 text-center md:text-left">
                        <h2 class="text-3xl font-bold text-gray-800 mb-2">
                            Welcome back, {{ user.first_name }} {{ user.last_name }}!
                        </h2>
                        <p class="text-gray-600 mb-4">Ready to analyze your data</p>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                            <div class="flex items-center justify-center md:justify-start">
                                <svg class="w-5 h-5 text-purple-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                </svg>
                                <span class="text-gray-700">{{ user.email }}</span>
                            </div>
                            <div class="flex items-center justify-center md:justify-start">
                                <svg class="w-5 h-5 text-purple-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                                </svg>
                                <span class="text-gray-700">{{ user.mobile_number }}</span>
                            </div>
                            <div class="flex items-center justify-center md:justify-start md:col-span-2">
                                <svg class="w-5 h-5 text-purple-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                                <span class="text-gray-700">{{ user.address }}, {{ user.city }}, {{ user.state }}, {{ user.country }} - {{ user.pincode }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- File Upload Section -->
            <div class="bg-white rounded-2xl shadow-xl p-8 mb-8 slide-in">
                <div class="flex items-center mb-6">
                    <div class="bg-purple-100 p-3 rounded-lg mr-4">
                        <svg class="w-8 h-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-2xl font-bold text-gray-800">Upload Dataset</h3>
                        <p class="text-gray-600">Upload your Excel or CSV file to begin analysis</p>
                    </div>
                </div>

                <form id="uploadForm" action="/upload" method="POST" enctype="multipart/form-data" class="space-y-4">
                    <div class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center hover:border-purple-500 transition">
                        <input type="file" name="file" id="fileInput" accept=".csv,.xlsx,.xls" required
                            class="block w-full text-sm text-gray-500 file:mr-4 file:py-3 file:px-6 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100 cursor-pointer">
                        <p class="mt-2 text-sm text-gray-500">Supported formats: CSV, XLSX, XLS</p>
                    </div>
                    <button type="submit" 
                            class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-4 rounded-xl font-semibold hover:from-purple-700 hover:to-indigo-700 transform hover:scale-105 transition duration-200 shadow-lg flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                        </svg>
                        Upload & Analyze Dataset
                    </button>
                </form>
            </div>

            <!-- Preprocessing Section -->
            <div class="bg-white rounded-2xl shadow-xl p-8 mb-8 slide-in">
                <h3 class="text-2xl font-bold mb-6 text-gray-800 flex items-center">
                    <svg class="w-7 h-7 text-purple-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path>
                    </svg>
                    Data Preprocessing
                </h3>

                <form action="/preprocess" method="POST" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Missing Value Handling -->
                        <div class="border-2 border-gray-200 rounded-xl p-6 hover:border-purple-300 transition">
                            <h4 class="font-semibold text-lg mb-4 text-gray-800 flex items-center">
                                <svg class="w-5 h-5 text-purple-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                                Missing Value Handling
                            </h4>
                            <div class="space-y-3">
                                <label class="flex items-center space-x-3 cursor-pointer hover:bg-gray-50 p-2 rounded">
                                    <input type="checkbox" name="preprocessing" value="drop_missing" class="w-4 h-4 text-purple-600 rounded focus:ring-purple-500">
                                    <span class="text-sm text-gray-700">Drop rows with missing values</span>
                                </label>
                                <label class="flex items-center space-x-3 cursor-pointer hover:bg-gray-50 p-2 rounded">
                                    <input type="checkbox" name="preprocessing" value="fill_mean" class="w-4 h-4 text-purple-600 rounded focus:ring-purple-500">
                                    <span class="text-sm text-gray-700">Fill with mean (numeric)</span>
                                </label>
                                <label class="flex items-center space-x-3 cursor-pointer hover:bg-gray-50 p-2 rounded">
                                    <input type="checkbox" name="preprocessing" value="fill_median" class="w-4 h-4 text-purple-600 rounded focus:ring-purple-500">
                                    <span class="text-sm text-gray-700">Fill with median (numeric)</span>
                                </label>
                                <label class="flex items-center space-x-3 cursor-pointer hover:bg-gray-50 p-2 rounded">
                                    <input type="checkbox" name="preprocessing" value="fill_mode" class="w-4 h-4 text-purple-600 rounded focus:ring-purple-500">
                                    <span class="text-sm text-gray-700">Fill with mode (categorical)</span>
                                </label>
                            </div>
                        </div>

                        <!-- Normalization -->
                        <div class="border-2 border-gray-200 rounded-xl p-6 hover:border-purple-300 transition">
                            <h4 class="font-semibold text-lg mb-4 text-gray-800 flex items-center">
                                <svg class="w-5 h-5 text-purple-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                                Normalization
                            </h4>
                            <div class="space-y-3">
                                <label class="flex items-center space-x-3 cursor-pointer hover:bg-gray-50 p-2 rounded">
                                    <input type="checkbox" name="preprocessing" value="standardize" class="w-4 h-4 text-purple-600 rounded focus:ring-purple-500">
                                    <span class="text-sm text-gray-700">Standardization (Z-score)</span>
                                </label>
                                <label class="flex items-center space-x-3 cursor-pointer hover:bg-gray-50 p-2 rounded">
                                    <input type="checkbox" name="preprocessing" value="minmax" class="w-4 h-4 text-purple-600 rounded focus:ring-purple-500">
                                    <span class="text-sm text-gray-700">Min-Max Scaling</span>
                                </label>
                                <label class="flex items-center space-x-3 cursor-pointer hover:bg-gray-50 p-2 rounded">
                                    <input type="checkbox" name="preprocessing" value="robust" class="w-4 h-4 text-purple-600 rounded focus:ring-purple-500">
                                    <span class="text-sm text-gray-700">Robust Scaling (robust to outliers)</span>
                                </label>
                                <label class="flex items-center space-x-3 cursor-pointer hover:bg-gray-50 p-2 rounded">
                                    <input type="checkbox" name="preprocessing" value="normalize_l2" class="w-4 h-4 text-purple-600 rounded focus:ring-purple-500">
                                    <span class="text-sm text-gray-700">Vector Normalization (L2)</span>
                                </label>
                            </div>
                        </div>

                        <!-- Outlier Treatment -->
                        <div class="border-2 border-gray-200 rounded-xl p-6 hover:border-purple-300 transition">
                            <h4 class="font-semibold text-lg mb-4 text-gray-800 flex items-center">
                                <svg class="w-5 h-5 text-purple-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                        d="M12 8v4m0 4h.01M21 12c0 4.418-3.582 8-8 8s-8-3.582-8-8 3.582-8 8-8 8 3.582 8 8z"/>
                                </svg>
                                Outlier Treatment
                            </h4>
                            <div class="space-y-3">
                                <label class="flex items-center space-x-3 cursor-pointer hover:bg-gray-50 p-2 rounded">
                                    <input type="checkbox" name="preprocessing" value="treat_outliers" class="w-4 h-4 text-purple-600 rounded focus:ring-purple-500">
                                    <span class="text-sm text-gray-700">Cap Outliers (IQR method)</span>
                                </label>
                            </div>
                        </div>

                        <!-- Encoding -->
                        <div class="border-2 border-gray-200 rounded-xl p-6 hover:border-purple-300 transition">
                            <h4 class="font-semibold text-lg mb-4 text-gray-800 flex items-center">
                                <svg class="w-5 h-5 text-purple-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h2a1 1 0 011 1v2H4a1 1 0 01-1-1V4zm0 7a1 1 0 011-1h2a1 1 0 011 1v2H4a1 1 0 01-1-1v-1zm0 7a1 1 0 011-1h2a1 1 0 011 1v2H4a1 1 0 01-1-1v-1M10 4h10M10 11h10M10 18h10"/>
                                </svg>
                                Encoding
                            </h4>
                            <div class="space-y-3">
                                <label class="flex items-center space-x-3 cursor-pointer hover:bg-gray-50 p-2 rounded">
                                    <input type="checkbox" name="preprocessing" value="one_hot" class="w-4 h-4 text-purple-600 rounded focus:ring-purple-500">
                                    <span class="text-sm text-gray-700">One-Hot Encoding (categorical)</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="flex items-center justify-end gap-3 mt-4">
                        <button type="submit" class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white px-6 py-3 rounded-lg font-semibold hover:from-purple-700 hover:to-indigo-700 transition">
                            Apply Preprocessing
                        </button>
                        <button id="refreshAnalyticsBtn" type="button" class="px-5 py-3 rounded-lg border border-gray-300 hover:bg-gray-50 transition">
                            Refresh Analytics
                        </button>
                    </div>
                </form>
            </div>

            <!-- Download Section (only show if data exists) -->
            {% if data_overview %}
            <div class="bg-white rounded-2xl shadow-xl p-8 mb-8 slide-in">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-2xl font-bold text-gray-800 mb-2">Download Processed Data</h3>
                        <p class="text-gray-600">Export your preprocessed dataset as CSV</p>
                    </div>
                    <a href="/download" class="bg-gradient-to-r from-green-500 to-green-600 text-white px-6 py-3 rounded-lg hover:from-green-600 hover:to-green-700 transition transform hover:scale-105 shadow-md flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                        </svg>
                        Download CSV
                    </a>
                </div>
            </div>
            {% endif %}

            <!-- Right Side: Chat Window -->
            <div class="w-96 flex flex-col">
                <div class="bg-white rounded-2xl shadow-xl flex flex-col sticky top-24" style="height: calc(100vh - 8rem);">
                    <!-- Chat Header -->
                    <div class="bg-gradient-to-r from-indigo-600 to-purple-600 p-4 rounded-t-2xl flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="bg-white/20 p-2 rounded-lg">
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-white font-bold text-lg">Data Agent</h3>
                                <p class="text-white/80 text-xs">Ask about your dataset</p>
                            </div>
                        </div>
                        <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                    </div>

                    <!-- Chat Messages -->
                    <div id="chat-box" class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50">
                        <div class="text-center text-sm text-gray-500 py-4">
                            <svg class="w-12 h-12 mx-auto mb-2 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-3.582 8-8 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 3.582-8 8-8s8 3.582 8 8z"></path>
                            </svg>
                            Start a conversation about your data
                        </div>
                    </div>

                    <!-- Chat Input -->
                    <div class="border-t border-gray-200 p-4 bg-white rounded-b-2xl">
                        <div class="flex gap-2">
                            <input 
                                id="chat-message" 
                                type="text" 
                                placeholder="Ask something about your dataset..." 
                                class="flex-1 border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-sm"
                                onkeypress="if(event.key === 'Enter') sendChatMessage()"
                            >
                            <button 
                                id="chat-send" 
                                onclick="sendChatMessage()"
                                class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-4 py-2 rounded-lg hover:from-indigo-700 hover:to-purple-700 transition transform hover:scale-105 shadow-md flex items-center"
                            >
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
/* ----------------------- üîî Toast Notification ----------------------- */
function showToast(message, type = "info") {
    let bg;
    switch (type) {
        case "success": bg = "linear-gradient(to right, #22c55e, #16a34a)"; break;
        case "error": bg = "linear-gradient(to right, #ef4444, #b91c1c)"; break;
        case "warning": bg = "linear-gradient(to right, #f59e0b, #b45309)"; break;
        default: bg = "linear-gradient(to right, #6366f1, #8b5cf6)";
    }
    Toastify({
        text: message,
        duration: 3000,
        gravity: "top",
        position: "right",
        stopOnFocus: true,
        close: true,
        style: {
            background: bg,
            borderRadius: "0.5rem",
            boxShadow: "0 4px 6px rgba(0,0,0,0.1)"
        }
    }).showToast();
}

function openDbModal() {
    document.getElementById('dbModal').classList.remove('hidden');
}
function closeDbModal() {
    document.getElementById('dbModal').classList.add('hidden');
}

document.getElementById('dbConnectForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(this);

    const res = await fetch('/connect_db', {
        method: 'POST',
        body: formData
    });

    const data = await res.json();

    if (data.success) {
        closeDbModal();
        Toastify({
            text: "‚úÖ Connected successfully!",
            backgroundColor: "#16a34a",
            duration: 4000
        }).showToast();

        document.getElementById('dbSchemaContainer').innerHTML = data.html;
    } else {
        Toastify({
            text: "‚ùå Connection failed: " + data.error,
            backgroundColor: "#dc2626",
            duration: 4000
        }).showToast();
    }
});

/* ----------------------- üîÑ Data Fetchers & Renderers ----------------------- */
async function fetchAnalytics() {
    const res = await fetch('/api/analytics');
    if (!res.ok) throw new Error('Failed to fetch analytics');
    return await res.json();
}

function createOrGetSection(sectionId, title, iconPath) {
    let section = document.getElementById(sectionId);
    if (!section) {
        section = document.createElement('div');
        section.id = sectionId;
        section.className = 'bg-white rounded-2xl shadow-xl p-8 mb-8 slide-in';
        
        const uploadSection = document.querySelector('form[action="/upload"]').closest('.bg-white');
        uploadSection.insertAdjacentElement('afterend', section);
    }
    return section;
}

function renderOverviewAndColumns(data) {
    if (!data.data_overview) return;

    const section = createOrGetSection('overviewSection', 'Dataset Overview', 'M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z');
    
    section.innerHTML = `
        <h3 class="text-2xl font-bold mb-6 text-gray-800 flex items-center">
            <svg class="w-7 h-7 text-purple-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            Dataset Overview
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <div class="stat-card bg-gradient-to-br from-blue-50 to-blue-100 p-6 rounded-xl border border-blue-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-semibold text-blue-600 mb-1">Total Rows</p>
                        <p class="text-3xl font-bold text-blue-700">${data.data_overview.total_rows}</p>
                    </div>
                    <svg class="w-12 h-12 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7h16M4 12h16M4 17h16"></path>
                    </svg>
                </div>
            </div>
            <div class="stat-card bg-gradient-to-br from-green-50 to-green-100 p-6 rounded-xl border border-green-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-semibold text-green-600 mb-1">Total Columns</p>
                        <p class="text-3xl font-bold text-green-700">${data.data_overview.total_columns}</p>
                    </div>
                    <svg class="w-12 h-12 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 4H5a2 2 0 00-2 2v14a2 2 0 002 2h4M9 4h10a2 2 0 012 2v14a2 2 0 01-2 2H9M9 4v16"></path>
                    </svg>
                </div>
            </div>
            <div class="stat-card bg-gradient-to-br from-yellow-50 to-yellow-100 p-6 rounded-xl border border-yellow-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-semibold text-yellow-600 mb-1">Missing Values</p>
                        <p class="text-3xl font-bold text-yellow-700">${data.data_overview.missing_values}</p>
                    </div>
                    <svg class="w-12 h-12 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                </div>
            </div>
            <div class="stat-card bg-gradient-to-br from-purple-50 to-purple-100 p-6 rounded-xl border border-purple-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-semibold text-purple-600 mb-1">Numeric Columns</p>
                        <p class="text-3xl font-bold text-purple-700">${data.data_overview.numeric_columns}</p>
                    </div>
                    <svg class="w-12 h-12 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14"></path>
                    </svg>
                </div>
            </div>
        </div>

        ${data.column_info && data.column_info.length > 0 ? `
        <div class="mt-8">
            <h4 class="text-lg font-semibold mb-4 text-gray-700">Column Information</h4>
            <div class="overflow-x-auto rounded-lg border border-gray-200">
                <table class="min-w-full bg-white">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Column Name</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Data Type</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Missing (%)</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Unique Values</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        ${data.column_info.map(col => `
                            <tr class="hover:bg-gray-50 transition">
                                <td class="px-6 py-4 text-sm font-medium text-gray-900">${col.name}</td>
                                <td class="px-6 py-4 text-sm text-gray-600">
                                    <span class="px-3 py-1 rounded-full text-xs font-semibold ${
                                        String(col.dtype).includes('int') || String(col.dtype).includes('float')
                                        ? 'bg-blue-100 text-blue-800'
                                        : (String(col.dtype).includes('object')
                                            ? 'bg-green-100 text-green-800'
                                            : 'bg-gray-100 text-gray-800')}"
                                    >${col.dtype}</span>
                                </td>
                                <td class="px-6 py-4 text-sm text-gray-600">
                                    <div class="flex items-center">
                                        <span class="${col.missing_percent > 10 ? 'text-red-600 font-semibold' : ''}">
                                            ${(col.missing_percent ?? 0).toFixed(2)}%
                                        </span>
                                    </div>
                                </td>
                                <td class="px-6 py-4 text-sm text-gray-600">${col.unique_values}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>
        ` : ''}
    `;
}

function renderStatistics(stats) {
    if (!stats || Object.keys(stats).length === 0) return;

    const section = createOrGetSection('statisticsSection', 'Statistical Summary', '');
    const columns = Object.keys(stats);
    const metrics = ['count','mean','std','min','25%','50%','75%','max'];

    section.innerHTML = `
        <h3 class="text-2xl font-bold mb-6 text-gray-800 flex items-center">
            <svg class="w-7 h-7 text-purple-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
            </svg>
            Statistical Summary
        </h3>
        <div class="overflow-x-auto rounded-lg border border-gray-200">
            <table class="min-w-full bg-white">
                <thead class="bg-gradient-to-r from-purple-50 to-indigo-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Metric</th>
                        ${columns.map(c => `<th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">${c}</th>`).join('')}
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    ${metrics.map(metric => `
                        <tr class="hover:bg-gray-50 transition">
                            <td class="px-6 py-4 text-sm font-semibold text-gray-900">${metric}</td>
                            ${columns.map(c => {
                                const val = stats[c]?.[metric];
                                return `<td class="px-6 py-4 text-sm text-gray-600">${typeof val === 'number' ? Number(val).toFixed(2) : (val ?? '')}</td>`;
                            }).join('')}
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
}

function renderPlots(plots) {
    if (!plots || (!plots.histograms && !plots.boxplots && !plots.heatmap)) return;

    const section = createOrGetSection('plotsSection', 'Visualizations', '');
    
    section.innerHTML = `
        <h3 class="text-2xl font-bold mb-6 text-gray-800 flex items-center">
            <svg class="w-7 h-7 text-indigo-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path>
            </svg>
            Data Distribution & Outlier Visualization
        </h3>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            ${plots.histograms ? `
            <div class="bg-gradient-to-br from-indigo-50 to-indigo-100 rounded-xl border border-indigo-200 p-4 shadow-md">
                <h4 class="text-lg font-semibold mb-3 text-indigo-700 flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3v18h18"></path>
                    </svg>
                    Histograms
                </h4>
                <img src="data:image/png;base64,${plots.histograms}" alt="Histograms" class="rounded-lg w-full">
            </div>
            ` : ''}

            ${plots.boxplots ? `
            <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-xl border border-green-200 p-4 shadow-md">
                <h4 class="text-lg font-semibold mb-3 text-green-700 flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                    Boxplots
                </h4>
                <img src="data:image/png;base64,${plots.boxplots}" alt="Boxplots" class="rounded-lg w-full">
            </div>
            ` : ''}
        </div>

        ${plots.heatmap ? `
        <div class="mt-8 bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl border border-purple-200 p-4 shadow-md">
            <h4 class="text-lg font-semibold mb-3 text-purple-700 flex items-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4h16v16H4z"></path>
                </svg>
                Correlation Heatmap
            </h4>
            <img src="data:image/png;base64,${plots.heatmap}" alt="Correlation Heatmap" class="rounded-lg w-full">
        </div>
        ` : ''}
    `;
}

/* ----------------------- üîÅ Refresh All ----------------------- */
async function refreshAll() {
    try {
        const data = await fetchAnalytics();
        renderOverviewAndColumns(data);
        renderStatistics(data.statistics || {});
        renderPlots(data.plots || {});
    } catch (err) {
        // Silently ignore - no dataset uploaded yet
        console.log('No dataset uploaded yet');
    }
}

/* ----------------------- üì§ Upload & Preprocess Handlers ----------------------- */
(function() {
    const preprocessForm = document.querySelector('form[action="/preprocess"]');
    const uploadForm = document.getElementById('uploadForm');
    const refreshBtn = document.getElementById('refreshAnalyticsBtn');

    if (refreshBtn) refreshBtn.addEventListener('click', refreshAll);

    // üü¢ Dataset Upload
    if (uploadForm) {
        uploadForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(uploadForm);
            try {
                const res = await fetch('/upload', { method: 'POST', body: formData });
                const data = await res.json();
                if (data.success) {
                    showToast(data.message || 'Dataset uploaded successfully!', 'success');
                    renderOverviewAndColumns(data);
                    renderStatistics(data.statistics || {});
                    renderPlots(data.plots || {});
                } else {
                    showToast(data.error || 'Upload failed', 'error');
                }
            } catch (err) {
                console.error('Upload error:', err);
                showToast('Upload failed due to network error', 'error');
            }
        });
    }

    // üü¢ Preprocess
    if (preprocessForm) {
        preprocessForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const steps = Array.from(preprocessForm.querySelectorAll('input[name="preprocessing"]:checked'))
                .map(i => i.value);
            try {
                const res = await fetch('/preprocess', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ steps })
                });
                const data = await res.json();
                if (data.success) {
                    showToast(data.message || 'Preprocessing completed successfully!', 'success');
                    renderOverviewAndColumns(data);
                    renderStatistics(data.statistics || {});
                    renderPlots(data.plots || {});
                } else {
                    showToast(data.error || 'Preprocessing failed', 'error');
                }
            } catch (err) {
                console.error('Preprocessing error:', err);
                showToast('Preprocessing failed due to network error', 'error');
            }
        });
    }
})();

/* ----------------------- üöÄ Init ----------------------- */
document.addEventListener('DOMContentLoaded', () => {
    refreshAll();
});

/* ----------------------- üí¨ Chat Functions ----------------------- */
function appendChatMessage(sender, text) {
    const chatBox = document.getElementById("chat-box");
    
    // Remove welcome message if it exists
    const welcomeMsg = chatBox.querySelector('.text-center');
    if (welcomeMsg) welcomeMsg.remove();
    
    const msgDiv = document.createElement("div");
    msgDiv.className = `flex ${sender === "user" ? "justify-end" : "justify-start"} mb-3`;
    
    const bubble = document.createElement("div");
    bubble.className = `max-w-xs px-4 py-2 rounded-2xl text-sm ${
        sender === "user" 
            ? "bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-tr-none" 
            : "bg-white text-gray-800 shadow-md rounded-tl-none border border-gray-200"
    }`;
    bubble.textContent = text;
    
    msgDiv.appendChild(bubble);
    chatBox.appendChild(msgDiv);
    chatBox.scrollTop = chatBox.scrollHeight;
}

async function sendChatMessage() {
    const input = document.getElementById("chat-message");
    const text = input.value.trim();
    if (!text) return;
    
    appendChatMessage("user", text);
    input.value = "";
    
    // Show typing indicator
    const chatBox = document.getElementById("chat-box");
    const typingDiv = document.createElement("div");
    typingDiv.className = "flex justify-start mb-3";
    typingDiv.id = "typing-indicator";
    typingDiv.innerHTML = `
        <div class="bg-white text-gray-800 shadow-md rounded-2xl rounded-tl-none border border-gray-200 px-4 py-2">
            <div class="flex space-x-1">
                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
            </div>
        </div>
    `;
    chatBox.appendChild(typingDiv);
    chatBox.scrollTop = chatBox.scrollHeight;
    
    try {
        const res = await fetch("/ai-chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message: text })
        });
        const data = await res.json();
        
        // Remove typing indicator
        document.getElementById("typing-indicator")?.remove();
        
        appendChatMessage("agent", data.reply);
    } catch (err) {
        document.getElementById("typing-indicator")?.remove();
        appendChatMessage("agent", "Sorry, I encountered an error. Please try again.");
        console.error("Chat error:", err);
    }
}
</script>


</body>
</html>